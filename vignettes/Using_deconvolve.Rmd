---
title: "Using deconvolve for lignocellulosic biomass estimates"
author: "Saras M. Windecker"
date: "`r Sys.Date()`"
output:
  html_document:
    css: deconvolve.css
    theme: lumen
    toc: yes
    toc_float:
      collapsed: no
      toc_depth: 4
#bibliography: bibliography.bib
runtime: shiny
vignette: >
  %\VignetteIndexEntry{Using deconvolve for lignocellulosic biomass estimates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r knitr_options, eval=TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# set up knitr options
knitr::opts_chunk$set(message = FALSE,
               warning = FALSE,
               fig.align = 'center',
               dev = c('png'),
               cache = TRUE,
               comment = NA)
```

```{r Library, echo=FALSE, message=FALSE, warning=FALSE}
library(deconvolve)
```

## Why deconvolution?

Ecologists are interested in determining the composition of plant cell wall biomass, primarily hemicellulose, cellulose, and lignin carbon types (collectively termed lignocellulosic biomass). Proportions of these carbon types are useful for estimating kinetic parameters or for calculation of intrinsic plant traits. Traditional methods for calculation of lignocellulosic biomass involve wet chemistry methods that can be monetarily and environmentally costly. Thermogravimetric analysis (TGA) is an alternative method, primarily used in the biofuel field, to approximate these carbon compounds from mass loss data obtained by heating a biomass sample (in a $N_2$ environment, termed pyrolysis). 

Thermogravimetry output consists of mass loss data, which can be converted to mass at each degree by adding the initial sample mass (Figures 1a, 1d). Carbon forms are known to pyrolyse at distinct temperature intervals, mostly independent from one another. Therefore if we plot the derivative thermogravimetric curve (DTG curve; Figure 1b), we can visualise the multi-peaked rate of mass loss with temperature increase (Figures 1b, 1e). This multi-peaked DTG curve can be modelled as a mixture of three  independent curves, which correspond to 'pseudo-hemicellulose' (P-HC), 'pseudo-cellulose' (P-CL), and 'pseudo-lignin' (P-LG; Figure 1c). In some plant material, thermal decay also produces a fourth peak that corresponds to soluble carbohydrates (P-SC; Figure 1f). We term these 'pseudo' components since these curves only approximately correspond to the mass fractions of each compound. The overall DTG curve is not solely composed of these pseudo-components, but it is a good approximation within an intermediate temperature range (roughly 400K to 900K). Lower than 400K mass loss is likely composed primarily of dehydration from water loss, and above 900K, mass lost may interact with volatiles, producing additional mass loss peaks that do not correspond to one of the primary biomass components. Resolving the form of the independent curves, termed 'deconvolution', allows us to estimate the mass of carbon types in the original sample by integrating the area under each curve.

```{r echo = F, cache = FALSE, out.width= '750px', fig.align = "center", fig.cap="*Figure 1. Outputs of deconvolution of thermogravimetric curves: mass against temperature (a, d), derivative thermogravimetric rate against temperature (b, e), and the deconvolved derivative thermogravimetric curves of each pseudo-component (c, e) for _Juncus usitatus_ (a-c) and _Marsilea drumondii_ (d-f).*"}
knitr::include_graphics("Figures/three_graphs.png")
```

This peak deconvolution is typically conducted in peak-fitting softwares, which, while effective, do not allow for transparent or reproducible workflows. This package seeks to provide a platform for reproducible deconvolution using R. This methodology has been tested on a range of plant litter composed primarily of soluble carbohydrates, hemicellulose, cellulose, and lignin. The functions will not be suitable for woody material, for example, that may be composed of other dominant carbon forms. 

<hr>

## Mixture model

The meat of this package is in the mixture model used to deconvolve the DTG curve. Many different mathematical models have been proposed to fit the form of the independent curves in a DTG curve, including Gassian, Lorentzian, Weibull, the asymmetric bi-Gaussian, and the Frazer-Suzuki distributions. Symmetric curves such as the Gaussian and Lorentzian curves struggle to model these kinetic curves because they are often asymmetric. The four-parameter Fraser-Suzuki function (\ref{single-fs}) is highly flexible and therefore performs well. You can play around with the four parameters, corresponding to height, skew, position, and width, in the widget below. 

\begin{equation}
\label{single-fs}
\frac{d\alpha}{dT} = h\ exp\bigg\{-\frac{ln2}{s^2}\Big[ln\Big(1 + 2s \frac{T- p}{w}\Big)\Big]^2\bigg\}
\end{equation}


```{r, echo = FALSE, cache = FALSE}
library(shiny)
shinyAppFile('shiny-app/single_fs/app.R')
```

\begin{equation}
\label{mixture-fs}
\frac{d\alpha}{dT}_{total} = \sum\limits_{i=1}^3 \frac{d\alpha}{dT}_{i}
\end{equation}

```{r, echo = FALSE, cache = FALSE}
shinyAppFile('shiny-app/mixture_fs/app.R')
```

<hr>

## Workflow

A suggested workflow to deconvolve thermogram data is presented below using data provided with the package, called `juncus`. This dataset contains raw TGA data from a sample of _Juncus usitatus_ and will fit a three-part mixture model. 

### 1. Load data

The juncus dataset contains temperature, in Celsius, as well as mass loss. When this dataset was downloaded from the TGA processing software it also contained several lines of information about the machine, the setting used, and the initial mass. To prep the data these lines had to be removed before the data was read into R.

``` {r}
head(juncus)
```

### 2. `process` data

The `process` function converts raw thermogram data to DTG data. If necessary, it will first convert temperature data to Kelvin and round temperature values so that the derivative can be accurately calculated.

This function requires the data frame, the name of the temperature column, the name of the mass loss column, the initial mass of your sample, as well as optional inputs for the temperature bounds to crop the data. The function defaults to temperature in Kelvin, but we can specify degrees Celsius by adding `temp_type = 'C'`. Here I am sticking with the default lower and upper bounds of 400 K and 900 K, but we could also change them by specifying them directly.

```{r}
munge <- process(juncus, 'temp_C', 'mass_loss', 18.96, temp_type = 'C')
munge
```

### 3. Plot mass loss and DTG curve

It is useful to examine your examine your DTG curve so that you can get a sense of the properties of your curve. You should look for where to crop your dataset (your 'bounds').

The default plotting option for your processed data is the DTG curve:

```{r}
plot(munge)
```

If you'd like to specify either the mass loss curve, or both curves, you can do so by modifying `plot_type`:

```{r}
plot(munge, plot_type = 'both')
```

### 4. `deconvolve` data

The `deconvolve` function takes default or user-defined lower and upper bounds and clips the dataset. It uses default or user-defined starting values to optimise parameter selection for the 12 parameters in the three-part mixture model. These optimised parameters are then used as the starting values in the nls model. Mass fractions of each of the three pseudo-components are calculated by taking the integral under each respective curve and expanding the mass of each fraction out of the total mass lost to the mass of each fraction of total sample mass.

```{r}
output <- deconvolve(munge)
output
```

### 5. Examine outputs

#### modified dataframe output
The output object is a list of four key outputs that we will use to understand our data. `$data` allows us to access our modified data frame. The deconvolve function has added several columns to it. This is provided so that you can play with the data yourself if you'd like.

```{r}
head(ModData(output))
```

#### bounds output
This shows us again the bounds we placed on our data, a helpful way to check what we included, or importantly, excluded.

```{r}
Bounds(output)
```

#### minpack.lm model output
This is the guts of our deconvolution. This presents the main output of the Fraser-Suzuki mixture model. We can see the 12 estimated parameter values. As a recap, 'h' indicates curve height, 's', curve skew, 'p' curve position', and 'w' curve width. The numbers 1, 2, and 3 refer to P-Hemicellulose, P-Cellulose, and P-Lignin, respectively.

```{r}
Model(output)
```

#### mass fractions output
If you are using the package to calculate mass fraction of the three pseudo-components, this is your main output of interest. This output lists the mass fraction for each.

```{r}
MassFrac(output)
```

### 6. Plot deconvolved curve

Take a look at your plot. Do the estimates seem reasonable? In many cases, the peak of P-HC occurs at the lowest temperature, followed by P-CL and finally P-LG. If your plot doesn't follow this pattern, can you think of an ecological explanation given your species/plant material type?

```{r}
plot(output)
```

<hr>

This work is still a work in progress! If you see any mistakes, or find that the code is not functioning well on your data, let me know at saras.windecker@gmail.com, or log a bug on github: http://www.github.com/smwindecker/deconvolve.

